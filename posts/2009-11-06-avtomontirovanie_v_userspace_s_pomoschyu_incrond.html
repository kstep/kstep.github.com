<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width">
        <title>//kstep blog</title>

        <link href="/feed.xml" rel="alternate" type="application/rss+xml" />
        <link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
        <link rel="stylesheet" href="/static/styles/materialize.min.css" />
        <link rel="stylesheet" href="/static/styles/github.css" />

<style>
.chip i.material-icons {
    padding-left: 0;
    padding-right: 8px;
    float: left;
}

body {
    display: flex;
    min-height: 100vh;
    flex-direction: column;
}

main {
    flex: 1 0 auto;
}

.social-links img {
    width: 16px;
    height: 16px;
    vertical-align: baseline;
    margin-right: 5px;
}
</style>
    </head>
    <body>

        <nav class="light-green lighten-2" role="navigation">
            <div class="nav-wrapper container">
                <div class="col s12">
                    <a class="breadcrumb" href="/">//kstep</a>
                    <span class="breadcrumb">Автомонтирование в userspace с помощью incrond</span>
                </div>
            </div>
        </nav>
        <main class="container">
        <h2>Автомонтирование в userspace с помощью incrond</h2>
        <div class="chip"><nobr><i class="material-icons">date_range</i> 06 Nov 2009 00:00:00 +0200</nobr></div>
        <p><a href="/#!/2009/07/10/avtomontirovanie_sshfscurlftpfs_s_pomoschyu_autofs_v_debiane.html">Раньше</a> я писал, как можно динамически монтировать устройства и хосты с помощью autofs. Этот способ не лишён недостатков, основной из которых — монтирование всегда из-под рута. А значит надо ставить рута в известность о своих паролях-ключах (то есть держать копию ~/.ssh и ~/.netrc в ~root), что далеко не всегда удобно, а кроме того вредно с точки зрения безопасности. Не говоря уже о том, что этот метод работает только если ты единственный, кто сидит за этим компом.</p>
<p>Решение мне <a href="http://welinux.ru/post/1779/#cmnt29144">подсказал</a> <a href="http://muhas.ru/">muhas</a>, и звучит оно просто — inotify.</p>
<p>Для моих же целей я посчитал, что лучшим решением будет использовать incrond. Это разновидность крона, которая запускает команды по событиям в файловой системе, а для слежения за файлам использует libinotify.</p>
<p>Нам потребуется: пакет incron (apt-get install incron), sshfs/curlftpfs (или ещё какие демоны-монтировщики, смотря что будем монтировать) и немного настроить инкрон.</p>
<p>Формат конфигов инкрона прост, как полено:</p>
<pre><code>имя_файла список_флагов_через_запятую команда_для_запуска
</code></pre>
<p>За подробностями отправляю в man 5 incrontab, а здесь скажу то, чего в манах нет, и на что сам напоролся. Дело в том, что поля в конфиге инкрона должны разделяться пробелом. Именно пробелом и именно одним. Табуляции и прочие «пробельные символы» не подходят. Серии пробелов — тоже, т.к. «лишние» пробелы в итоге попадут либо в список флагов, либо в имя команды, так что рискуете получить в сислоге ошибку «выполняемый файл не найден», т.к. инкрон попытается запутить не «команду_для_запуска», а « команду_для_запуска», с лидирующими пробелами в имени команды.</p>
<p>Теперь, собственно, конфигурация:</p>
<pre><code>mkdir -p ~/remote/ssh ~/remote/ftp ~/remote/ftpa
</code></pre>
<p>Каталог ftpa нужен для монтирования хостов в активном режиме (есть у меня пара таких хостингов, что такое требуют).</p>
<p>Дальше добавляем себя в /etc/incron.allow, чтобы инкрон нас допустил к себе:</p>
<pre><code>sudo vim /etc/incron.allow
&lt;добавляем строчку со своим логином&gt;
</code></pre>
<p>Теперь правим инкронтаб:</p>
<pre><code>incrontab -e

/home/kstep/remote/ssh IN_ATTRIB,IN_CREATE,IN_NO_LOOP sshfs -f $#: $@/$#
/home/kstep/remote/ftp IN_ATTRIB,IN_CREATE,IN_NO_LOOP curlftpfs -f $# $@/$#
/home/kstep/remote/ftpa IN_ATTRIB,IN_CREATE,IN_NO_LOOP curlftpfs -f -o ftp_port=- $# $@/$#
</code></pre>
<p>IN_CREATE монтирует при создании каталога с именем хоста в соответствующем подкаталоге ~/remote. Если такой каталог уже есть, то благодаря IN_ATTRIB монтирование произойдёт на touch. Это не так удобно, как в случае с autofs, но другого выхода я пока не нашёл.</p>
<p>IN_NO_LOOP не даёт монтировать каталог второй раз, до тех пор пока он не размонтируется. Реально этот флаг не даёт инкрону продолжать следить за файлом-каталогом до тех пор, пока не завершиться запущенный процесс-обработчик. А так как curlftpfs и sshfs по дефолту становятся демонами, то я им даю флаг -f, чтобы они оставались на виду и не демонизировались, не давая тем самым инкрону запускать себя второй раз.</p>
<p>Собственно вот, эта связка прекрасно работает у меня на данный момент =)</p>

        </main>
        <footer class="page-footer light-green lighten-2">
            <div class="container">
                <div class="row social-links">
                    <div class="col s6">
                        <h5 class="white-text">Author</h5>
                        <p class="white-text">
                        Konstantin Stepanov<br />
                        Professional software developer since 2003 from Minsk, Belarus.<br />
                        Now works at <a href="http://www.adform.com">Adform</a>.
                        Writes professinally in Scala, hobby language is <a href="http://rust-lang.org">Rust</a>.<br />
                        Blogs in Russian and English.<br />
                        Email: <a href="mailto:me@kstep.me">me@kstep.me</a>.
                        </p>
                    </div>
                    <div class="col s6">
                        <h5 class="white-text">Links</h5>
                        <div class="col s3">
                        <ul>
                            <li><a class="grey-text text-lighten-3" href="https://twitter.com/kstepme"><img src="https://twitter.com/favicon.ico" /> Twitter</a></li>
                            <li><a class="grey-text text-lighten-3" href="http://www.linkedin.com/pub/konstantin-stepanov/54/47/450"><img src="http://www.linkedin.com/favicon.ico" /> LinkedIn</a></li>
                            <li><a class="grey-text text-lighten-3" href="http://kstepme.moikrug.ru/"><img src="http://moikrug.ru/favicon.ico" /> Мой Круг</a></li>
                            <li><a class="grey-text text-lighten-3" href="http://welinux.ru/user/kstep/"><img src="http://welinux.ru/favicon.ico" /> WeLinux</a></li>
                        </ul>
                        </div>
                        <div class="col s3">
                        <ul>
                            <li><a class="grey-text text-lighten-3" href="https://github.com/kstep"><img src="http://github.com/favicon.ico" /> Github</a></li>
                            <li><a class="grey-text text-lighten-3" href="http://www.ohloh.net/accounts/kstep"><img src="http://www.ohloh.net/favicon.ico" /> Ohloh</a></li>
                            <li><a class="grey-text text-lighten-3" href="http://search.cpan.org/~kstepme/"><img src="http://search.cpan.org/favicon.ico" />CPAN</a></li>
                            <li><a class="grey-text text-lighten-3" href="http://habrahabr.ru/users/kstep/"><img src="http://habrahabr.ru/favicon.ico" /> Habrahabr</a></li>
                        </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="footer-copyright">
                <div class="container">
                    &copy; <a href="https://github.com/kstep/kstep.github.com" class="white-text">2009&ndash;2016</a> Konstantin Stepanov
                </div>
            </div>

            <script src="/static/highlight.pack.js"></script>
            <script>hljs.initHighlightingOnLoad();</script>
        </footer>

    </body>
</html>

