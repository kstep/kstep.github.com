<!DOCTYPE html>
<html lang="en" ng-app="kstep" ng-controller="RootCtl">
    <head>
        <meta charset="utf-8">
        <title ng-bind="page.title | strip_tags"></title>
        <meta name="description" content="{: page.description :}">
        <meta name="author" content="Konstantin Stepanov" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.0/css/bootstrap-combined.min.css" rel="stylesheet" type="text/css" />
        <link href="/static/default.css" rel="stylesheet" type="text/css" />

        <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
        <!--[if lt IE 9]><script src="http://html5shim.googlecode.com/svn/trunk/html5.js" type="text/javascript"></script><![endif]-->

        <style type="text/css">
            .totop {
                display: block;
                background: #fafafa;
                border: 1px solid #d4d4d4;
                border-radius: 5px;
                color: #333333;
                font-size: 18px;
                padding: 10px 0;
                text-align: center;
                text-decoration: none;
                width: 40px;
                position: fixed;
                bottom: 60px;
                right: 30px;
                box-shadow: 0 -1px 10px rgba(0, 0, 0, 0.1);
            }

            #content.container {
                margin-bottom: 60px;
                margin-top: 60px;
            }

            @media (max-width: 979px) {
                #content.container {
                    margin-bottom: 0;
                    margin-top: 0;
                }
            }

            .loading {
                text-decoration: blink;
            }
        </style>
    </head>

    <body>
        <header class="navbar navbar-fixed-top">
            <div class="navbar-inner">
                <div class="container">
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>

                    <a class="brand" href="/#!/" ng-class="{ loading: $loading }">//kstep</a>

                    <div class="nav-collapse collapse">
                        <ul class="nav">
                            <li><a target="_blank" href="https://twitter.com/kstepme"><img src="http://twitter.com/favicon.ico" /> Twitter</a></li>
                            <li><a target="_blank" href="http://www.linkedin.com/pub/konstantin-stepanov/54/47/450"><img src="http://www.linkedin.com/favicon.ico" /> LinkedIn</a></li>
                            <li><a target="_blank" href="http://kstepme.moikrug.ru/"><img src="http://moikrug.ru/favicon.ico" /> Мой Круг</a></li>
                        </ul>
                        <ul class="nav pull-right">
                            <li ng-class="{ active: lang == 'en' }"><a ng-click="lang = 'en'">English</a></li>
                            <li ng-class="{ active: lang == 'ru' }"><a ng-click="lang = 'ru'">Russian</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </header>

        <div class="container" id="content">
            <div class="content" ng-view>
            </div>

        </div> <!-- /container -->

        <footer class="navbar navbar-fixed-bottom">
            <div class="navbar-inner">
                <div class="container">
                    <ul class="nav">
                        <li><span class="navbar-text">&copy; Konstantin Stepanov 2012</span></li>
                    </ul>
                </div>
            </div>
        </footer>

        <a class="totop">↑</a>

        <!--[if lt IE 9]>
        <script src="http:http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->

        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/angularjs/1.0.2/angular.min.js"></script>
        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/angularjs/1.0.2/angular-sanitize.min.js"></script>
        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/angularjs/1.0.2/angular-cookies.min.js"></script>

        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
        <script type="text/javascript" src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.0/js/bootstrap.min.js"></script>

<script type="text/javascript">
function valueFn(value) {
    return function () { return value; };
}

!function (angular, document, $, undefined) {
    angular.module('kstep', ['ng', 'ngSanitize', 'ngCookies'])
    .config(['$routeProvider', '$locationProvider', '$interpolateProvider',
    function ($route, $location, $interpolate) {
        $route
        .when('/', { controller: 'BlogCtl', templateUrl: '/posts/list.html' })
        .when('/:year/:month/:day/:name.html', { controller: 'PostCtl', templateUrl: '/posts/post.html' })
        .otherwise({ redirectTo: '/' });

        $location.html5Mode(false).hashPrefix('!');

        $interpolate.startSymbol('{:').endSymbol(':}');
    }])

    .filter('strip_tags', [function () {
        var tag_re = /<\/[a-zA-Z][a-zA-Z0-9]*>|<[a-zA-Z][a-zA-Z0-9]*(\s+[^>]*?)?>/g;
        return function (value) {
            return (value || '').toString().replace(tag_re, '');
        };
    }])
    .filter('asdate', ['$filter', function ($filter) {
        return function (value, pattern) {
            return $filter('date')(new Date(value), pattern);
        };
    }])

    .value('locales', {
        'en': {
            lang: 'en',
            index_title: 'My little cosy blog',
            date_format: 'M/d/yyyy'
        },
        'ru': {
            lang: 'ru',
            index_title: 'Мой уютненький бложек',
            date_format: 'dd.MM.yyyy'
        }
    })

    .directive('totop', ['$window', function ($window) {
        return {
            restrict: 'AC',
            compile: function (elem, attrs) {
                var win = $($window);

                win.bind('scroll', function (ev) {
                    elem.css('display', win.scrollTop() > win.height() / 3? '': 'none');
                });

                elem.css('display', 'none');

                return function (scope, elem, attrs) {
                    elem.bind('click', function () {
                        win.scrollTop(0);
                        elem.css('display', 'none');
                    });
                };
            }
        };
    }])

    .controller('RootCtl', ['$scope', '$http', 'locales', '$cookies', function ($scope, $http, locales, $cookies) {
        $scope.page = {};
        $scope.lang = $cookies.lang || 'en';

        $scope.$on('$routeChangeStart', function () {
            $scope.$loading = true;
        });
        $scope.$on('$routeChangeSuccess', function () {
            $scope.$loading = false;
        });
        $scope.$on('$routeChangeError', function () {
            $scope.$loading = false;
        });

        $scope.$watch('lang', function (lang) {
            $scope.locale = locales[lang] || locales.en;
            $cookies.lang = lang;
        });
    }])

    .controller('PostCtl', ['$scope', '$routeParams', function ($scope, $params) {
        angular.extend($scope.page, {
            url:   '/' + $params.year + '/' + $params.month + '/' + $params.day + '/' + $params.name + '.html',
            group: 'blog'
        });
    }])
    .controller('BlogCtl', ['$scope', '$routeParams', '$http', function ($scope, $params, $http) {
        $scope.$watch('locale.index_title', function (locale_title) {
            $scope.page.title = locale_title;
        });

        angular.extend($scope.page, {
            title: $scope.locale.index_title,
            url:   '/',
            group: 'blog'
        });

        $scope.posts = $http.get('/posts/list.json');
    }])
    ;
}(window.angular, window.document, window.jQuery);
</script>

  </body>
</html>

