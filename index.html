<!DOCTYPE html>
<html lang="en" ng-app="kstep" ng-controller="RootCtl">
    <head>
        <meta charset="utf-8">
        <title ng-bind="page.title | strip_tags"></title>
        <meta name="description" content="{: page.description :}">
        <meta name="author" content="Konstantin Stepanov" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.0/css/bootstrap-combined.min.css" rel="stylesheet" type="text/css" />
        <link href="/static/default.css" rel="stylesheet" type="text/css" />

        <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
        <!--[if lt IE 9]><script src="http://html5shim.googlecode.com/svn/trunk/html5.js" type="text/javascript"></script><![endif]-->

        <style type="text/css">
            .ng-cloak {
                display: none !important;
            }

            img.favicon {
                width: 16px;
                height: 16px;
                vertical-align: middle;
            }

            .totop {
                z-index: 1000;
                display: block;
                background: #fafafa;
                border: 1px solid #d4d4d4;
                border-radius: 5px;
                color: #333333;
                font-size: 18px;
                padding: 10px 0;
                text-align: center;
                text-decoration: none;
                width: 40px;
                position: fixed;
                bottom: 60px;
                right: 30px;
                box-shadow: 0 -1px 10px rgba(0, 0, 0, 0.1);
            }

            .tag {
                margin-right: 0.5em;
            }

            #content.container {
                margin-bottom: 60px;
                margin-top: 60px;
            }

            @media (max-width: 979px) {
                #content.container {
                    margin-bottom: 0;
                    margin-top: 0;
                }
            }

            .loading {
                text-decoration: blink;
                color: #dddddd !important;
            }

            #loading-indicator {
                z-index: 5000;
                position: fixed;
                top: 50%;
                left: 50%;
                width: 100px;
                padding: 10px 0;
                line-height: 20px;
                display: block;
                background: #fafafa;
                border: 1px solid #d4d4d4;
                border-radius: 5px;
                text-align: center;
                margin-top: -20px;
                margin-left: -50px;
                text-decoration: blink;
                color: #333333;
                box-shadow: 0 -1px 10px rgba(0, 0, 0, 0.1);
            }

            .navbar .nav.social-icons > li > a {
                padding-left: 8px;
                padding-right: 8px;
            }

            iframe[classname^="twitter-timeline"], .twitter-timeline {
                width: 100% !important;
            }
        </style>
    </head>

    <body>
        <header class="navbar navbar-fixed-top ng-cloak">
            <div class="navbar-inner">
                <div class="container">
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>

                    <a class="brand" href="/#!/" ng-class="{ loading: $loading }">//kstep</a>

                    <div class="btn-group pull-right">
                        <button ng-click="lang = 'en'" ng-class="{ active: lang == 'en' }" class="btn">en</button>
                        <button ng-click="lang = 'ru'" ng-class="{ active: lang == 'ru' }" class="btn">ru</button>
                    </div>

                    <div class="nav-collapse collapse">
                        <ul class="nav">
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">{: locale.in_social_networks :} <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    <li ng-repeat="acc in social_accounts"><a target="_blank" ng-href="{: acc.url :}"><img class="favicon" ng-src="{: acc.icon :}" /> {: acc.name :}</a></li>
                                </ul>
                            </li>
                            <li><a ng-href="{: 'znvygb:zr@xfgrc.zr' | rot13 :}" title="{: locale.no_spam_please :}">{: locale.email_me :}</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </header>

        <div class="modal-backdrop ng-cloak" ng-show="$loading"></div>
        <div ng-show="$loading" id="loading-indicator" ng-bind="locale.loading" class="ng-cloak"></div>

        <noscript>
            <div class="container">
                <h1>Hello!</h1>
                <p>I'm sorry, but you <strong>have</strong> to enable JavaScript to view my site.</p>
                <p>I know, I know, JS dependency makes my site not-so-accessible, but hey, we live in 21st century!</p>
                <p>So why bother? Just turn your JavaScript on and enjoy.</p>
                <p><strong>Sidenote:</strong> if you have to browse web with something like Lynx, well, I'm sorry for you. Maybe I will add no-JS browsers support in the future, though it's unlikely.</p>
            </div>
        </noscript>

        <div class="container ng-cloak" id="content">
            <div class="row">
                <div class="content span9" ng-view></div>
                <div class="span3">
                    <a class="twitter-timeline" data-dnt="true" href="https://twitter.com/kstepme" data-widget-id="272776746049339393">Tweets by @kstepme</a>
                    <script type="text/javascript" src="//platform.twitter.com/widgets.js"></script>
                </div>
            </div>
        </div> <!-- /container -->

        <footer class="navbar navbar-fixed-bottom ng-cloak">
            <div class="navbar-inner">
                <div class="container">
                    <ul class="nav">
                        <li><span class="navbar-text">{: locale.signature :} 2012</span></li>
                    </ul>
                    <ul class="nav pull-right social-icons">
                        <li ng-repeat="acc in social_accounts"><a target="_blank" ng-href="{: acc.url :}" title="{: acc.name :}"><img class="favicon" ng-src="{: acc.icon :}" alt="{: acc.name :}" /></a></li>
                    </ul>
                </div>
            </div>
        </footer>

        <a class="totop ng-cloak">↑</a>

        <!--[if lt IE 9]>
        <script src="http:http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->

        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/angularjs/1.0.2/angular.min.js"></script>
        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/angularjs/1.0.2/angular-sanitize.min.js"></script>
        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/angularjs/1.0.2/angular-cookies.min.js"></script>

        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
        <script type="text/javascript" src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.0/js/bootstrap.min.js"></script>

<script type="text/javascript">
function valueFn(value) {
    return function () { return value; };
}

!function (angular, document, $, undefined) {
    angular.module('kstep', ['ng', 'ngSanitize', 'ngCookies'])
    .config(['$routeProvider', '$locationProvider', '$interpolateProvider',
    function ($route, $location, $interpolate) {
        $route
        .when('/', { controller: 'BlogCtl', templateUrl: '/partials/list.html' })
        .when('/:year/:month/:day/:name.html', { controller: 'PostCtl', templateUrl: '/partials/post.html' })
        .when('/tags', { controller: 'TagsCtrl', templateUrl: '/partials/tags.html' })
        .when('/tag/:tag', { controller: 'TagCtrl', templateUrl: '/partials/tag.html' })
        .otherwise({ redirectTo: '/' });

        $location.html5Mode(false).hashPrefix('!');

        $interpolate.startSymbol('{:').endSymbol(':}');
    }])

    .filter('strip_tags', [function () {
        var tag_re = /<\/[a-zA-Z][a-zA-Z0-9]*>|<[a-zA-Z][a-zA-Z0-9]*(\s+[^>]*?)?>/g;
        return function (value) {
            return (value || '').toString().replace(tag_re, '');
        };
    }])
    .filter('rot13', [function () {
        var latin_re = /[a-zA-Z]/g,
            decode = function (c) {
                return String.fromCharCode((c <= "Z"? 90: 122) >= (c = c.charCodeAt(0) + 13)? c: c - 26);
            };

        return function (value) {
            return (value || '').toString().replace(latin_re, decode);
        };
    }])
    .filter('asdate', ['$filter', function ($filter) {
        return function (value, pattern) {
            return $filter('date')(new Date(value), pattern);
        };
    }])

    .value('locales', {
        'en': {
            lang: 'en',
            index_title: 'My little cosy blog',
            in_social_networks: '…in social networks',
            email_me: 'email me',
            no_spam_please: 'No spam, please!',
            loading: 'Loading…',
            tags: 'Tags',
            tag: 'Tag',
            tag_cloud: 'Tag cloud',
            signature: '© Konstantin Stepanov',
            date_format: 'M/d/yyyy'
        },
        'ru': {
            lang: 'ru',
            index_title: 'Мой уютненький бложек',
            in_social_networks: '…в соцсетях',
            email_me: 'напишите мне',
            no_spam_please: 'Только без спама, пожалуйста!',
            loading: 'Загрузка…',
            tags: 'Теги',
            tag: 'Тег',
            tag_cloud: 'Облако тегов',
            signature: '© Константин Степанов',
            date_format: 'dd.MM.yyyy'
        }
    })

    .directive('totop', ['$window', function ($window) {
        return {
            restrict: 'AC',
            compile: function (elem, attrs) {
                var win = $($window);

                win.bind('scroll', function (ev) {
                    elem.css('display', win.scrollTop() > win.height() / 3? '': 'none');
                });

                elem.css('display', 'none');

                return function (scope, elem, attrs) {
                    elem.bind('click', function () {
                        win.scrollTop(0);
                        elem.css('display', 'none');
                    });
                };
            }
        };
    }])

    .factory('$jsload', ['$timeout', '$q', '$document', '$rootScope', function ($timeout, $q, $document, $root) {
        var cache = {},
            queue = {};

        return function (src, force) {
            if (queue[src]) {
                return queue[src];
            }

            var deferred = $q.defer();

            if (!force && cache[src]) {
                deferred.resolve(cache[src]);

            } else {
                queue[src] = deferred.promise;

                $timeout(function () {
                    var script = $document[0].createElement('script');
                    script.type = 'text/javascript';
                    script.async = true;
                    script.src = src;

                    script.onerror = function (ev) {
                        delete queue[src];
                        deferred.reject(script);
                        $root.$digest();
                    };
                    script.onreadystatechange = script.onload = function (ev) {
                        delete queue[src];
                        if (!ev.readyState || ev.readyState === 'loaded') {
                            cache[src] = script;
                            deferred.resolve(script);
                            $root.$digest();
                        }
                    };

                    $document[0].getElementsByTagName('head')[0].appendChild(script);
                });
            }

            return deferred.promise;
        };
    }])

    .factory('Pager', [function () {
        return function (list, items_per_page, current_page) {

            var length = list.length,
                total_pages = Math.ceil(length / items_per_page);

            this.total_pages = 0;
            this.pages = [];

            this.set_page = function (new_page) {
                var total_pages = Math.ceil(list.length / items_per_page);
                if (total_pages != this.total_pages) {
                    this.total_pages = total_pages;
                    this.pages = [];
                    for (var p = 0; p < total_pages; p++) {
                        this.pages.push(p + 1);
                    }
                }

                if (new_page < 1) {
                    new_page = 1;
                } else if (new_page > total_pages) {
                    new_page = total_pages;
                }

                this.page = new_page;

                var from = (new_page - 1) * items_per_page,
                    to = from + items_per_page;
                this.slice = list.slice(from, to);
            };

            this.set_page(current_page);
        };
    }])

    .factory('Disqus', ['$window', '$jsload', function ($window, $jsload) {
        return function (shortname) {
            return $jsload('http://' + shortname + '.disqus.com/embed.js', true).then(function () {
                return $window.DISQUS;
            });
        }
    }])

    .directive('disqus', ['$location', '$window', 'Disqus', '$parse', function ($location, $window, Disqus, $parse) {
        var id_seq = 0;

        return {
            restrict: 'ACE',
            terminal: true,
            compile: function (elem, attrs) {
                var shortname = attrs.disqus || attrs.name,
                    id = attrs.id;

                if (!shortname) { return; }
                if (!id) {
                    id = 'disqus_thread' + (id_seq++);
                    elem.attr('id', id);
                }

                return function (scope, elem, attrs) {
                    $window.disqus_identifier = $location.path();
                    $window.disqus_url = $location.absUrl();
                    $window.disqus_container_id = id;

                    Disqus(shortname);
                    elem.html('');
                }
            }
        };
    }])

    .config(['$httpProvider', function ($http) {
        $http.responseInterceptors.push(function ($rootScope, $q) {
            return function (promise) {
                $rootScope.$loading = true;

                return promise.then(
                function (response) {
                    $rootScope.$loading = false;
                    return response;
                },
                function (response) {
                    $rootScope.$loading = false;
                    return $q.reject(response);
                })
            };
        });
    }])

    .controller('RootCtl', ['$scope', '$http', 'locales', '$cookies', function ($scope, $http, locales, $cookies) {
        $scope.page = {};
        $scope.lang = $cookies.lang || 'en';

        $scope.$watch('lang', function (lang) {
            $scope.locale = locales[lang] || locales.en;
            $cookies.lang = lang;
        });

        $scope.social_accounts = [
            { url: "https://twitter.com/kstepme", icon: "http://twitter.com/favicon.ico", name: "Twitter" },
            { url: "http://www.linkedin.com/pub/konstantin-stepanov/54/47/450", icon: "http://www.linkedin.com/favicon.ico", name: "LinkedIn" },
            { url: "http://kstepme.moikrug.ru/", icon: "http://moikrug.ru/favicon.ico", name: "Мой Круг" },
            { url: "http://welinux.ru/user/kstep/", icon: "http://welinux.ru/favicon.ico", name: "WeLinux" },
            { url: "https://github.com/kstep", icon: "http://github.com/favicon.ico", name: "Github" },
            { url: "http://www.ohloh.net/accounts/kstep", icon: "http://www.ohloh.net/favicon.ico", name: "Ohloh" },
            { url: "http://search.cpan.org/~kstepme/", icon: "http://search.cpan.org/favicon.ico", name: "CPAN" }
        ];
    }])

    .directive('ngMeta', ['$parse', function ($parse) {
        return {
            restrict: 'E',
            terminal: true,
            compile: function (elem, attrs) {
                if (!attrs.value && !attrs.update) {
                    return;
                }

                var nameExpr = $parse(attrs.name),
                    valueExpr = attrs.value? $parse(attrs.value): null,
                    updateExpr = attrs.update? $parse(attrs.update): null;

                return function (scope, elem, attrs) {
                    if (valueExpr) {
                        nameExpr.assign(scope, valueExpr(scope));
                    }
                    if (updateExpr) {
                        angular.extend(nameExpr(scope), updateExpr(scope));
                    }
                };
            }
        };
    }])

    .controller('PostCtl', ['$scope', '$routeParams', function ($scope, $params) {
        angular.extend($scope.page, {
            url:   '/' + $params.year + '/' + $params.month + '/' + $params.day + '/' + $params.name + '.html',
            group: 'blog'
        });
    }])
    .controller('BlogCtl', ['$scope', '$routeParams', '$http', 'Pager', function ($scope, $params, $http, Pager) {
        $scope.$watch('locale.index_title', function (locale_title) {
            $scope.page.title = locale_title;
        });

        angular.extend($scope.page, {
            title: $scope.locale.index_title,
            url:   '/',
            group: 'blog'
        });

        $scope.pager = $http.get('/data/list.json').then(
            function (result) {
                return new Pager(result.data, 40, 1);
            }
        );
    }])
    .controller('TagCtrl', ['$scope', '$http', '$routeParams', function ($scope, $http, $params) {
        $scope.$watch('locale.tag', function (locale_title) {
            $scope.page.title = locale_title + ' — ' + $params.tag;
        });

        $http.get('/data/tags.json').then(function (result) {
            $scope.tag = result.data[$params.tag];
            $scope.tag.name = $params.tag;
        });
    }])
    .controller('TagsCtrl', ['$scope', '$http', function ($scope, $http) {
        $scope.$watch('locale.tag_cloud', function (locale_title) {
            $scope.page.title = locale_title;
        });

        $http.get('/data/tags.json').then(function (result) {
            $scope.tags = result.data;
        });
    }])
    ;
}(window.angular, window.document, window.jQuery);
</script>

  </body>
</html>

